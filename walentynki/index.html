<!DOCTYPE html>
<html lang="pl">

<head>
    <link rel="stylesheet" id="stylesheet" href="style.css">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">-->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300&display=swap" rel="stylesheet">
    <title>
        Walentynki | Mobilny Katolik
    </title>
    <link rel="icon" type="image/png" href="favicon.png" />
</head>

<body>

<div id="unauthorised" class="page" style="display: none;">
    <center>
        <br><br><br><br><br><br>
        <img src="error.png" width="200px" height="200px">
        <br><br>
        <h1>Nieautoryzowany użytkownik</h1>
        <h2>Zaloguj się za pomocą ICSU</h2>
    </center>
</div>

<div id="main-page" class="page" style="display: none;">
    <div class="heading">
        <div class="logo"></div>
    </div>
    <div class="page-content">
        <center>
            <br><br><br>
            <h1>Zarządzanie zamówieniami</h1>
            <button class="menu-button" onClick="createOrder();">➕ Nowe zamówienie</button><br>
            <!--<button class="menu-button">✏️ Edytuj zamówienie</button>-->
        </center>
    </div>
</div>

<div id="order-display" class="page" style="display: none;">
    <div class="heading">
        <div class="logo"></div>
    </div>
    <div class="page-content">
        <div id="order-loading">
            <center><br><br><br><br><br>
                Proszę czekać...
            </center>
        </div>
        <div id="order-display-details">
            <!--<h1>Podsumowanie</h1>
            <hr>
            <div id="flowers-summary" style="display: none;">
                <h2>Kwiaty</h2>
                <h3 id="flowers-summary-list"></h3>
                <h3 style="text-align: right;"><span id="flowers-summary-sum">0.00</span> zł</h3>
                <hr>
            </div>
            <div id="others-summary" style="display: none;">
                <h2>Dodatki</h2>
                <h3 id="others-summary-list"></h3>
                <h3 style="text-align: right;"><span id="others-summary-sum">0.00</span> zł</h3>
                <hr>
            </div>
            <h4>Inne szczegóły: <span id="order-details">-</span></h4>
            <h2 style="font-weight: bold; text-align: right;">Do zapłaty: <span id="summary-sum">0.00</span> zł</h2>-->
        </div>
    </div>
</div>

<div id="order-wizard" class="page" style="display: none;">
    <div class="heading">
        <div class="logo"></div>
        <div class="wizard-price">Suma: <span id="full-price">0.00</span> zł</div>
    </div>
    <div class="page-content">

        <!--Wybór kwiatów-->
        <div id="step1">
            <h2>Wybierz kwiaty</h2>
            <table class="flowers-select">
                <tr>
                    <td><button onClick="changeAmount('-', 0)">-</button> <span id="flower-0-quantity">0</span> <button onClick="changeAmount('+', 0)">+</button></td>
                    <td>Róża czerwona</td>
                </tr>
                <tr>
                    <td><button onClick="changeAmount('-', 1)">-</button> <span id="flower-1-quantity">0</span> <button onClick="changeAmount('+', 1)">+</button></td>
                    <td>Róża różowa</td>
                </tr>
                <tr>
                    <td><button onClick="changeAmount('-', 2)">-</button> <span id="flower-2-quantity">0</span> <button onClick="changeAmount('+', 2)">+</button></td>
                    <td>Róża biała</td>
                </tr>
                <tr>
                    <td><button onClick="changeAmount('-', 3)">-</button> <span id="flower-3-quantity">0</span> <button onClick="changeAmount('+', 3)">+</button></td>
                    <td>Róża żółta/pomarańczowa</td>
                </tr>
                <tr>
                    <td><button onClick="changeAmount('-', 4)">-</button> <span id="flower-4-quantity">0</span> <button onClick="changeAmount('+', 4)">+</button></td>
                    <td>Tulipan czerwony/różowy</td>
                </tr>
            </table>
        </div>
        <div id="step2" style="display: none;">
            <center>
                <br><br>
                <img src="info.png" width="150px" height="150px">
                <br><br>
                <h1>Zapytaj, czy skompletować Zestaw Amora?</h1>
                <h3>TYLKO DZISIAJ PROMOCJA - W ZESTAWIE AMORA CIASTECZKA GRATIS</h3>
                <button class="choice-button" style="background-color: #589d7c; color: #ffffff" onClick="nextStep();">TAK, skompletuj Zestaw Amora</button>
                <button class="choice-button" style="background-color: #ffffff; color: #ff0000" onClick="nextStep(1)">NIE, przejdź dalej</button>
            </center>
        </div>
        <div id="step3" style="display: none;">
            <h2>Zestaw Amora - kartka</h2>
            <select onChange="countPrice();" id="card-select">
                <option value="0" selected>Brak kartki</option>
                <option value="1">Kartka BASIC (+1.00 zł)</option>
                <option value="2">Kartka PREMIUM (+2.00 zł)</option>
            </select>
        </div>
        <div id="step4" style="display: none;">
            <center>
                <br><br>
                <img src="info.png" width="150px" height="150px">
                <br><br>
                <h1 id="promo">Zapytaj, czy dołączyć ciasteczka? (+2.00 zł)</h1>
                <input type="checkbox" id="cookies-select" onClick="countPrice();"><span id="promo2"> Dodaj ciasteczka (+2.00 zł)</span>
            </center>
        </div>
        <div id="step5" style="display: none;">
            <center>
                <br><br>
                <img src="info.png" width="150px" height="150px">
                <br><br>
                <h1>Zapytaj o Mobilny Katolik</h1>
            </center>
        </div>
        <div id="step6" style="display: none;">
            <h1>Podsumowanie</h1>
            <hr>
            <div id="flowers-summary" style="display: none;">
                <h2>Kwiaty</h2>
                <h3 id="flowers-summary-list"></h3>
                <h3 style="text-align: right;"><span id="flowers-summary-sum">0.00</span> zł</h3>
                <hr>
            </div>
            <div id="others-summary" style="display: none;">
                <h2>Dodatki</h2>
                <h3 id="others-summary-list"></h3>
                <h3 style="text-align: right;"><span id="others-summary-sum">0.00</span> zł</h3>
                <hr>
            </div>
            <h4>Inne szczegóły: <span id="order-details">-</span></h4>
            <h2 style="font-weight: bold; text-align: right;">Do zapłaty: <span id="summary-sum">0.00</span> zł</h2>
        </div>
        <div id="step7" style="display: none;">
            <center><br><br><br><br><br>
                Proszę czekać...
            </center>
        </div>
        <div id="step8" style="display: none;">

            <center>
                <h2 style="margin: 0;">Zamówienie nr <b id="ending-orderid">0001</b></h2>
                <h3>Uzupełnij formularz zgodnie z poniższą wizualizacją</h3>
            </center>
            <div id="form1" class="small-form" style="display: none;">
                <span style="top: 64px; left: 16px;" id="form1-flower0">0</span>
                <span style="top: 70px; left: 16px;" id="form1-flower1">0</span>
                <span style="top: 77px; left: 16px;" id="form1-flower2">0</span>
                <span style="top: 7px; left: 119px;" id="form1-flower3">0</span>
                <span style="top: 14px; left: 119px;" id="form1-flower4">0</span>
                <span style="top: 18px; left: 119px;" id="form1-cookies">✓</span>
                <span style="top: -85px; left: 135px;" id="form1-orderid">0000</span>
                <span style="width: 100px; top: -106px; left: 215px;" id="form1-fullprice">00.00 zł</span>
            </div>

            <div id="form2" class="big-form" style="display: none;">
                <span style="top: 59px; left: 11px;" id="form2-flower0">0</span>
                <span style="top: 65px; left: 11px;" id="form2-flower1">0</span>
                <span style="top: 72px; left: 11px;" id="form2-flower2">0</span>
                <span style="top: 2px; left: 105px;" id="form2-flower3">0</span>
                <span style="top: 7px; left: 105px;" id="form2-flower4">0</span>
                <span style="top: 11px; left: 105px;" id="form2-cookies">✓</span>
                <span style="top: -90px; left: 198px;" id="form2-orderid">0000</span>
                <span style="width: 100px; top: 200px; left: 5px;" id="form2-flowersprice">00.00 zł</span>
                <span style="width: 100px; top: 181px; left: 87px;" id="form2-othersprice">00.00 zł</span>
                <span style="width: 100px; top: 161px; left: 180px;" id="form2-fullprice">00.00 zł</span>
            </div>

        </div>
        <div id="step9" style="display: none;">
            <h1>Dalsze instrukcje</h1>
            <ul>
                <li>Do formularza dołącz etykietę do kwiatów</li>
                <li id="to-do-with-form">Formularz należy wypełnić i wrzucić do skrzynki walentynkowej</li>
            </ul>
        </div>
        <div id="step10" style="display: none;">
            <center>
                <br><br>
                <img src="success.png" width="150px" height="150px">
                <br><br>
                <h1>Zamówienie pomyślnie zapisane!</h1><br><br>
                <button class="menu-button" onClick="home();">Wróć do ekranu głównego</button>
            </center>
        </div>
        <div id="step-error" style="display: none;">
            <center>
                <br><br>
                <img src="error.png" width="150px" height="150px">
                <br><br>
                <h1 style="margin: 0;">Wystąpił błąd</h1>
                <h2>Spróbuj ponownie</h2>
            </center>
        </div>




    </div>
    <div class="wizard-footer">
        <div class="wizard-button" id="wizard-button-prev" style="float: left; text-align: left;" onClick="prevStep();">« WRÓĆ</div>
        <div class="wizard-button" id="wizard-button-next" style="float: right; text-align: right;" onClick="nextStep();">DALEJ »</div>
        <div class="wizard-progress-bar" id="wizard-progress-bar"></div>
    </div>
</div>


</body>

</html>

<script>
var icsuData = localStorage.getItem("icsu");
var accessCode;
if (icsuData == null) {
    document.getElementById("unauthorised").style.display = "block";
} else {
    accessCode = icsuData.split(";")[0];
    document.getElementById("main-page").style.display = "block";
}


const flowerPrices = [4.00, 4.00, 4.00, 4.00, 3.50]
const flowerNames = ["Róża czerwona", "Róża różowa", "Róża biała", "Róża żółta/pomarańczowa", "Tulipan czerwony/różowy"]
const cardPrices = [0.00, 1.00, 2.00]
const cardNames = [null, "Kartka BASIC", "Kartka PREMIUM"]


var flowerAmount = [0, 0, 0, 0, 0]
var step = 0;
const steps = 10;
document.getElementById("wizard-progress-bar").style.width = String((step/steps)*100)+"%";

//PROMOCJA
var promo = "";

var editedOrder = "none";

function home() {
    document.getElementById("step1").style.display = "block";
    document.getElementById("step2").style.display = "none";
    document.getElementById("step3").style.display = "none";
    document.getElementById("step4").style.display = "none";
    document.getElementById("step5").style.display = "none";
    document.getElementById("step6").style.display = "none";
    document.getElementById("step7").style.display = "none";
    document.getElementById("step8").style.display = "none";
    document.getElementById("step9").style.display = "none";
    document.getElementById("step10").style.display = "none";
    document.getElementById("step-error").style.display = "none";
    document.getElementById("order-wizard").style.display = "none";
    document.getElementById("order-display").style.display = "none";
    document.getElementById("main-page").style.display = "block";
    document.getElementById("cookies-select").checked = "";
    document.getElementById("card-select").value = "0";
    document.getElementById("wizard-button-prev").style.display = "block";
    document.getElementById("wizard-button-next").style.display = "block";
}

function showOrder() {
    window.prompt("Podaj numer zamówienia");
    document.getElementById("order-loading").style.display = "block";
    document.getElementById("main-page").style.display = "none";
    document.getElementById("order-display").style.display = "block";
    document.getElementById("order-display-details").style.display = "block";
    document.getElementById("order-loading").style.display = "none";




}

function changeAmount(sign, index) {
    var flowerSum = 0;
    for (let flower in flowerAmount) {
        flowerSum += flowerAmount[flower]
    }
    if (sign == "-" && flowerAmount[index] > 0) {
        flowerAmount[index] -= 1
    } else if ((sign == "+") && flowerSum < 11) {
        flowerAmount[index] += 1
    }
    for (let flower in flowerAmount) {
        document.getElementById(`flower-${flower}-quantity`).innerHTML = String(flowerAmount[flower]);
    }
    countPrice();
}

function createOrder() {
    step = 1;
    flowerAmount = [0, 0, 0, 0, 0]
    document.getElementById("main-page").style.display = "none";
    document.getElementById("order-wizard").style.display = "block";
    for (let flower in flowerAmount) {
        document.getElementById(`flower-${flower}-quantity`).innerHTML = "0";
    }
    setTimeout(() => {
        countPrice();
        document.getElementById("wizard-progress-bar").style.width = String((step/steps)*100)+"%";
    }, 100)
}

function prevStep() {
    document.getElementById("step-error").style.display = "none";
    if (step == 1) {
        if(!window.confirm("Czy na pewno chcesz opuścić proces tworzenia zamówienia? Postęp nie zostanie zapisany.")) {
            return false;
        }
        step = 0;
        document.getElementById("wizard-progress-bar").style.width = String((step/steps)*100)+"%";
        document.getElementById("order-wizard").style.display = "none";
        document.getElementById("main-page").style.display = "block";
        return false;
    }
    document.getElementById(`step${step}`).style.display = "none"
    step -= 1
    document.getElementById(`step${step}`).style.display = "block"
    document.getElementById("wizard-progress-bar").style.width = String((step/steps)*100)+"%";

    //Ukrywanie przycisku DALEJ
    if (step == 2) {
        document.getElementById("wizard-button-next").style.display = "none";
    } else if (step == 7) {
        document.getElementById("wizard-button-prev").style.display = "none";
        document.getElementById("wizard-button-next").style.display = "none";
        endOrder();
    } else if (step == 8) {
        document.getElementById("wizard-button-prev").style.display = "none";
        document.getElementById("wizard-button-next").style.display = "block";
    } else if (step == 9) {
        document.getElementById("wizard-button-prev").style.display = "block";
        document.getElementById("wizard-button-next").style.display = "block";
    } else if (step == 10) {
        document.getElementById("wizard-button-prev").style.display = "none";
        document.getElementById("wizard-button-next").style.display = "none";
    } else {
        document.getElementById("wizard-button-prev").style.display = "block";
        document.getElementById("wizard-button-next").style.display = "block";
    }
    countPrice()
}

function nextStep(skip) {
    if (step == 1) {
        var flowerSum = 0;
        for (let flower in flowerAmount) {
            flowerSum += flowerAmount[flower]
        }
        if (flowerSum == 0) {
            window.alert("Nie wybrano żadnych kwiatów")
            return false;
        }
    } else if (step == 6) {
        if (!window.confirm("Upewnij się, że kupujący zapłacił za zamówienie.\nKliknij OK, aby kontynuować."))  {
            return false;
        }
    }
    document.getElementById(`step${step}`).style.display = "none"
    step += 1
    if (skip != undefined) {
        step += skip
    }
    document.getElementById(`step${step}`).style.display = "block"
    document.getElementById("wizard-progress-bar").style.width = String((step/steps)*100)+"%";

    //Ukrywanie przycisku DALEJ
    if (step == 2) {
        document.getElementById("wizard-button-next").style.display = "none";
    } else if (step == 7) {
        document.getElementById("wizard-button-prev").style.display = "none";
        document.getElementById("wizard-button-next").style.display = "none";
        endOrder();
    } else if (step == 8) {
        document.getElementById("wizard-button-prev").style.display = "none";
        document.getElementById("wizard-button-next").style.display = "block";
    } else if (step == 9) {
        document.getElementById("wizard-button-prev").style.display = "block";
        document.getElementById("wizard-button-next").style.display = "block";
    } else if (step == 10) {
        document.getElementById("wizard-button-prev").style.display = "none";
        document.getElementById("wizard-button-next").style.display = "none";
    } else {
        document.getElementById("wizard-button-prev").style.display = "block";
        document.getElementById("wizard-button-next").style.display = "block";
    }
    countPrice()
}

function countPrice() {
    var fullPrice = 0;
    var flowerPrice = 0;
    var othersPrice = 0;
    //Kwiaty
    for (let flower in flowerAmount) {
        flowerPrice += flowerAmount[flower]*flowerPrices[flower]
    }
    //Kartka
    othersPrice += cardPrices[parseInt(document.getElementById("card-select").value)];
    //PROMOCJA
    if (document.getElementById("card-select").value == "0") {
        document.getElementById("promo").innerHTML = "Zapytaj, czy dołączyć ciasteczka? (+2.00 zł)"
        document.getElementById("promo2").innerHTML = " Dodaj ciasteczka (+2.00 zł)"
    } else {
        document.getElementById("promo").innerHTML = "Zapytaj, czy dołączyć ciasteczka? (+0.00 zł)"
        document.getElementById("promo2").innerHTML = " Dodaj ciasteczka (+0.00 zł)"
    }
    //Ciasteczka
    if (document.getElementById("cookies-select").checked) {
        //PROMOCJA
        if (document.getElementById("card-select").value == "0") {
            othersPrice += 2;
            promo = "";
        } else {
            promo = ";promo";
        }
    } else {
        promo = "";
    }
    fullPrice = flowerPrice + othersPrice;
    flowerPrice = (Math.round(flowerPrice * 100) / 100).toFixed(2)
    othersPrice = (Math.round(othersPrice * 100) / 100).toFixed(2)
    fullPrice = (Math.round(fullPrice * 100) / 100).toFixed(2)
    document.getElementById("full-price").innerHTML = String(fullPrice);

    //Wypisywanie listy kwiatów na podsumowaniu
    var flowersSummary = []
    for (let flower in flowerAmount) {
        if (flowerAmount[flower] == 0) {
            continue;
        }
        flowersSummary.push(`${flowerAmount[flower]}x ${flowerNames[flower]}`)
    }
    document.getElementById("flowers-summary-list").innerHTML = flowersSummary.join("<br>")
    document.getElementById("flowers-summary-sum").innerHTML = String(flowerPrice);
    if (document.getElementById("flowers-summary-list").innerHTML != "") {
        document.getElementById("flowers-summary").style.display = "block"
    } else {
        document.getElementById("flowers-summary").style.display = "none"
    }
    
    //Wypisywanie listy dodatków na podsumowaniu
    var othersSummary = []
    if (document.getElementById("cookies-select").checked) {
        othersSummary.push("Ciasteczka")
    }
    if (cardNames[parseInt(document.getElementById("card-select").value)] != null) {
        othersSummary.push(cardNames[parseInt(document.getElementById("card-select").value)])
        document.getElementById("order-details").innerHTML = "ZESTAW AMORA"
    } else {
        document.getElementById("order-details").innerHTML = "-"
    }
    document.getElementById("others-summary-list").innerHTML = othersSummary.join("<br>")
    document.getElementById("others-summary-sum").innerHTML = String(othersPrice);
    if (document.getElementById("others-summary-list").innerHTML != "") {
        document.getElementById("others-summary").style.display = "block"
    } else {
        document.getElementById("others-summary").style.display = "none"
    }
    
    //Ustawianie ceny końcowej na podsumowaniu
    document.getElementById("summary-sum").innerHTML = String(fullPrice);

    return {flowerPrice, othersPrice, fullPrice};
}

function endOrder() {
    var form;
    var type;
    document.getElementById("form1").style.display = "none";
    document.getElementById("form2").style.display = "none";

    //Wybór formularza - w zależności od wyboru kartki
    if (document.getElementById("card-select").value == "0") {
        form = "1"
        type = "flowers"
        document.getElementById("to-do-with-form").innerHTML = "Formularz należy wypełnić i wrzucić <b>do skrzynki walentynkowej</b>"
    } else {
        form = "2"
        type = "package"
        document.getElementById("to-do-with-form").innerHTML = "Formularz należy wypełnić i przynieść wraz z kartką <b>do stoiska walentynkowego</b>"
    }

    for (let flower in flowerAmount) {
        if (flowerAmount[flower] == 0) {
            document.getElementById(`form${form}-flower${flower}`).innerHTML = "X"
        } else {
            document.getElementById(`form${form}-flower${flower}`).innerHTML = flowerAmount[flower]
        }
    }

    if (document.getElementById("cookies-select").checked) {
        document.getElementById(`form${form}-cookies`).innerHTML = "✓"
    } else {
        document.getElementById(`form${form}-cookies`).innerHTML = "X"
    }

    if (form == "2") {
        document.getElementById("form2-flowersprice").innerHTML = String(countPrice().flowerPrice)+" zł";
        document.getElementById("form2-othersprice").innerHTML = String(countPrice().othersPrice)+" zł";
    }

    document.getElementById(`form${form}-fullprice`).innerHTML = String(countPrice().fullPrice)+" zł";
    document.getElementById(`form${form}`).style.display = "block";

    //Wysyłka danych do API
    var data = flowerAmount.join(";")+";"+String(document.getElementById("cookies-select").checked)+";"+String(document.getElementById("card-select").value)+promo

    console.log(data);


    var url = "https://api.katoliktczew.repl.co/walentynki/63880597";

    var xhr = new XMLHttpRequest();
    xhr.open("POST", url);

    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
        if (xhr.status == 200) {
            document.getElementById(`form${form}-orderid`).innerHTML = xhr.responseText;
            document.getElementById("ending-orderid").innerHTML = xhr.responseText;
            nextStep();
        } else {
            document.getElementById(`step${step}`).style.display = "none"
            document.getElementById("step-error").style.display = "block";
            document.getElementById("wizard-button-prev").style.display = "block";
            document.getElementById("wizard-button-next").style.display = "none";
        }
        
    }};

    var apiData = `{
        "type": "${type}",
        "content": "${data}",
        "orderid": "${editedOrder}"
    }`;

    xhr.send(apiData);

}


</script>